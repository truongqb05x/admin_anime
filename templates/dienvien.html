<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý diễn viên - Hệ thống quản trị phim</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="../static/css/dienvien.css">
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2><i class="fas fa-film"></i> Quản trị phim</h2>
        </div>
        <div class="sidebar-menu">
            <ul>
                <li><a href="/"><i class="fas fa-home"></i> <span>Tổng quan</span></a></li>
                <li><a href="/movies"><i class="fas fa-video"></i> <span>Quản lý phim</span></a></li>
                <li><a href="/dien-vien" class="active"><i class="fas fa-theater-masks"></i> <span>Diễn viên</span></a></li>
                <li><a href="/the-loai"><i class="fas fa-list"></i> <span>Thể loại</span></a></li>
                <li><a href="/countries"><i class="fas fa-globe"></i> <span>Quốc gia</span></a></li>
                <li><a href="/episodes"><i class="fas fa-play-circle"></i> <span>Tập phim</span></a></li>
                <li><a href="/users"><i class="fas fa-users"></i> <span>Người dùng</span></a></li>
            </ul>
        </div>
        <div class="sidebar-footer">
            <p>Phiên bản 2.0.1</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1><i class="fas fa-theater-masks"></i> Quản lý diễn viên</h1>
            </div>
            <div class="header-right">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Tìm kiếm diễn viên...">
                </div>
                <div class="notification">
                    <i class="fas fa-bell"></i>
                    <div class="notification-badge">3</div>
                </div>
                <div class="user-profile">
                    <div class="user-avatar">AD</div>
                    <div class="user-info">
                        <div class="user-name">Quản trị viên</div>
                        <div class="user-role">Super Admin</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Page Header -->
            <div class="page-header">
                <div class="page-title">Danh sách diễn viên</div>
                <div class="page-actions">
                    <button class="btn btn-outline"><i class="fas fa-filter"></i> Lọc</button>
                    <button class="btn btn-primary" id="addActorBtn"><i class="fas fa-plus"></i> Thêm diễn viên</button>
                </div>
            </div>

            <!-- View Toggle -->
            <div class="view-toggle">
                <div class="view-option active" data-view="grid">
                    <i class="fas fa-th"></i> Lưới
                </div>
                <div class="view-option" data-view="table">
                    <i class="fas fa-list"></i> Bảng
                </div>
            </div>

            <!-- Filter Bar -->
            <div class="filter-bar">
                <div class="filter-group">
                    <div class="filter-label">Sắp xếp</div>
                    <select class="filter-select" id="sortSelect">
                        <option value="name_asc">Tên A-Z</option>
                        <option value="name_desc">Tên Z-A</option>
                        <option value="movies_asc">Phim ít nhất</option>
                        <option value="movies_desc">Phim nhiều nhất</option>
                        <option value="newest">Mới nhất</option>
                        <option value="oldest">Cũ nhất</option>
                    </select>
                </div>
                <div class="filter-group">
                    <div class="filter-label">Số lượng phim</div>
                    <select class="filter-select" id="movieCountFilter">
                        <option value="">Tất cả</option>
                        <option value="1-5">1-5 phim</option>
                        <option value="6-10">6-10 phim</option>
                        <option value="11-20">11-20 phim</option>
                        <option value="20+">Trên 20 phim</option>
                    </select>
                </div>
                <div class="filter-group">
                    <div class="filter-label">Tìm kiếm</div>
                    <input type="text" class="filter-input" id="searchFilter" placeholder="Nhập tên diễn viên...">
                </div>
            </div>

            <!-- Actors Grid View -->
            <div class="actors-grid" id="gridView">
                <!-- Actors will be populated dynamically -->
            </div>

            <!-- Actors Table View -->
            <div class="table-container" id="tableView" style="display: none;">
                <div class="table-header">
                    <h2 id="actorCount">Danh sách diễn viên</h2>
                    <div>
                        <button class="btn btn-outline"><i class="fas fa-file-export"></i> Xuất Excel</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Ảnh</th>
                            <th>Tên diễn viên</th>
                            <th>Số phim</th>
                            <th>Phim nổi bật</th>
                            <th>Ngày thêm</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="actorsTableBody">
                        <!-- Actors will be populated dynamically -->
                    </tbody>
                </table>
                
                <!-- Pagination -->
                <div class="pagination" id="pagination">
                    <!-- Pagination buttons will be populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>© 2023 Hệ thống Quản trị Phim. Phiên bản 2.0.1</p>
        </div>
    </div>

    <!-- Add/Edit Actor Modal -->
    <div class="modal" id="actorModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Thêm diễn viên mới</div>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="actorForm" enctype="multipart/form-data">
                    <div class="form-group">
<input type="text" class="form-control" id="actorName" name="name" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Ảnh diễn viên</label>
                        <div class="photo-upload">
                            <div class="photo-preview" id="photoPreview">
                                <i class="fas fa-user"></i>
                            </div>
                            <input type="file" id="photoUpload" name="photo" accept="image/*" style="display: none;">
                            <button type="button" class="upload-btn" id="uploadTrigger">
                                <i class="fas fa-upload"></i> Tải ảnh lên
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="actorPhotoUrl">URL ảnh</label>
                        <input type="text" class="form-control" id="actorPhotoUrl" name="photo_url" placeholder="Hoặc nhập URL ảnh trực tiếp">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="actorMovies">Phim đã tham gia</label>
                        <select class="form-control form-select" id="actorMovies" name="movie_ids" multiple>
                            <!-- Movies will be populated dynamically -->
                        </select>
                        <small style="color: var(--gray); font-size: 0.8rem;">Giữ Ctrl để chọn nhiều phim</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelBtn">Hủy</button>
                <button class="btn btn-primary" id="saveActorBtn">Lưu diễn viên</button>
            </div>
        </div>
    </div>

    <script>
        let currentActorId = null;
        let currentView = 'grid';

        // Fetch and display actors
        function fetchActors(page = 1, sort = 'name_asc', search = '', movieCount = '') {
            $.ajax({
                url: '/api/actors',
                method: 'GET',
                success: function(data) {
                    const actors = data;
                    $('#gridView').empty();
                    $('#actorsTableBody').empty();
                    $('#actorCount').text(`Danh sách diễn viên (${actors.length} diễn viên)`);

                    actors.forEach(actor => {
                        // Grid view
                        $('#gridView').append(`
                            <div class="actor-card" data-id="${actor.id}">
                                <img src="${actor.photo_url || 'https://via.placeholder.com/300x400'}" class="actor-photo" alt="${actor.name}">
                                <div class="actor-info">
                                    <div class="actor-name">${actor.name}</div>
                                    <div class="actor-movies">${actor.movie_count} phim</div>
                                    <div class="actor-actions">
                                        <div class="action-btn edit-btn" data-id="${actor.id}"><i class="fas fa-edit"></i></div>
                                        <div class="action-btn delete-btn" data-id="${actor.id}"><i class="fas fa-trash"></i></div>
                                    </div>
                                </div>
                            </div>
                        `);

                        // Table view
                        $('#actorsTableBody').append(`
                            <tr data-id="${actor.id}">
                                <td><img src="${actor.photo_url || 'https://via.placeholder.com/45x45'}" class="actor-avatar" alt="${actor.name}"></td>
                                <td>${actor.name}</td>
                                <td>${actor.movie_count}</td>
                                <td>${actor.notable_movies || ''}</td>
                                <td>${actor.created_at}</td>
                                <td>
                                    <div class="action-buttons">
                                        <div class="action-btn edit-btn" data-id="${actor.id}"><i class="fas fa-edit"></i></div>
                                        <div class="action-btn delete-btn" data-id="${actor.id}"><i class="fas fa-trash"></i></div>
                                    </div>
                                </td>
                            </tr>
                        `);
                    });

                    // Simple pagination (client-side for simplicity)
                    const totalPages = Math.ceil(actors.length / 10);
                    $('#pagination').empty();
                    if (totalPages > 1) {
                        $('#pagination').append('<div class="pagination-btn"><i class="fas fa-chevron-left"></i></div>');
                        for (let i = 1; i <= totalPages; i++) {
                            $('#pagination').append(`<div class="pagination-btn ${i === page ? 'active' : ''}">${i}</div>`);
                        }
                        $('#pagination').append('<div class="pagination-btn"><i class="fas fa-chevron-right"></i></div>');
                    }
                },
                error: function(xhr) {
                    alert('Không thể tải danh sách diễn viên: ' + xhr.responseJSON.error);
                }
            });
        }

        // Fetch movies for the modal
        function fetchMovies() {
            $.ajax({
                url: '/api/movies',
                method: 'GET',
                success: function(data) {
                    $('#actorMovies').empty();
                    data.forEach(movie => {
                        $('#actorMovies').append(`<option value="${movie.id}">${movie.title}</option>`);
                    });
                },
                error: function(xhr) {
                    alert('Không thể tải danh sách phim: ' + xhr.responseJSON.error);
                }
            });
        }

        // Sidebar menu handling
        $('.sidebar-menu a').on('click', function() {
            $('.sidebar-menu a').removeClass('active');
            $(this).addClass('active');
        });

        // View toggle handling
        $('.view-option').on('click', function() {
            const viewType = $(this).data('view');
            $('.view-option').removeClass('active');
            $(this).addClass('active');
            
            if (viewType === 'grid') {
                $('#gridView').css('display', 'grid');
                $('#tableView').css('display', 'none');
                currentView = 'grid';
            } else {
                $('#gridView').css('display', 'none');
                $('#tableView').css('display', 'block');
                currentView = 'table';
            }
        });

        // Modal handling
        const actorModal = $('#actorModal');
        const addActorBtn = $('#addActorBtn');
        const closeModal = $('#closeModal');
        const cancelBtn = $('#cancelBtn');
        const saveActorBtn = $('#saveActorBtn');
        const modalTitle = $('#modalTitle');
        const uploadTrigger = $('#uploadTrigger');
        const photoUpload = $('#photoUpload');
        const photoPreview = $('#photoPreview');

        // Open modal for adding actor
        addActorBtn.on('click', function() {
            modalTitle.text('Thêm diễn viên mới');
            $('#actorForm')[0].reset();
            photoPreview.html('<i class="fas fa-user"></i>');
            currentActorId = null;
            fetchMovies();
            actorModal.css('display', 'flex');
        });

        // Close modal
        function closeActorModal() {
            actorModal.css('display', 'none');
            $('#actorForm')[0].reset();
            photoPreview.html('<i class="fas fa-user"></i>');
            currentActorId = null;
        }

        closeModal.on('click', closeActorModal);
        cancelBtn.on('click', closeActorModal);

        // Handle file upload preview
        uploadTrigger.on('click', function() {
            photoUpload.click();
        });

        photoUpload.on('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoPreview.html(`<img src="${e.target.result}" alt="Preview">`);
                };
                reader.readAsDataURL(file);
            }
        });

        // Save actor (add or update)
        saveActorBtn.on('click', function() {
            const formData = new FormData($('#actorForm')[0]);
            const url = currentActorId ? `/api/actors/${currentActorId}` : '/api/actors';
            const method = currentActorId ? 'PUT' : 'POST';

            $.ajax({
                url: url,
                method: method,
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    alert(response.message);
                    closeActorModal();
                    fetchActors();
                },
                error: function(xhr) {
                    alert('Lỗi: ' + xhr.responseJSON.error);
                }
            });
        });

        // Edit actor
        $(document).on('click', '.edit-btn', function() {
            currentActorId = $(this).data('id');
            const row = $(this).closest(currentView === 'grid' ? '.actor-card' : 'tr');
            const name = row.find(currentView === 'grid' ? '.actor-name' : 'td:eq(1)').text();
            const photo_url = row.find(currentView === 'grid' ? '.actor-photo' : '.actor-avatar').attr('src');

            modalTitle.text('Chỉnh sửa diễn viên');
            $('#actorName').val(name);
            $('#actorPhotoUrl').val(photo_url);
            photoPreview.html(`<img src="${photo_url}" alt="Preview">`);
            fetchMovies();

            // Fetch associated movies
            $.ajax({
                url: `/api/actors/${currentActorId}`,
                method: 'GET',
                success: function(actor) {
                    const movieIds = actor.notable_movies ? actor.notable_movies.split(', ').map(title => {
                        return $('#actorMovies option').filter(function() { return $(this).text() === title; }).val();
                    }) : [];
                    $('#actorMovies').val(movieIds);
                    actorModal.css('display', 'flex');
                }
            });
        });

        // Delete actor
        $(document).on('click', '.delete-btn', function() {
            const id = $(this).data('id');
            const name = $(this).closest(currentView === 'grid' ? '.actor-card' : 'tr')
                .find(currentView === 'grid' ? '.actor-name' : 'td:eq(1)').text();

            if (confirm(`Bạn có chắc chắn muốn xóa diễn viên "${name}" không?`)) {
                $.ajax({
                    url: `/api/actors/${id}`,
                    method: 'DELETE',
                    success: function(response) {
                        alert(response.message);
                        fetchActors();
                    },
                    error: function(xhr) {
                        alert('Lỗi: ' + xhr.responseJSON.error);
                    }
                });
            }
        });

        // Initial fetch
        fetchActors();
    </script>
</body>
</html>