<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý tập phim - Hệ thống quản trị phim</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="../static/css/tapphim.css">
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2><i class="fas fa-film"></i> Quản trị phim</h2>
        </div>
        <div class="sidebar-menu">
            <ul>
                <li><a href="dashboard.html"><i class="fas fa-home"></i> <span>Tổng quan</span></a></li>
                <li><a href="movies.html"><i class="fas fa-video"></i> <span>Quản lý phim</span></a></li>
                <li><a href="actors.html"><i class="fas fa-theater-masks"></i> <span>Diễn viên</span></a></li>
                <li><a href="genres.html"><i class="fas fa-list"></i> <span>Thể loại</span></a></li>
                <li><a href="countries.html"><i class="fas fa-globe"></i> <span>Quốc gia</span></a></li>
                <li><a href="#" class="active"><i class="fas fa-play-circle"></i> <span>Tập phim</span></a></li>
                <li><a href="users.html"><i class="fas fa-users"></i> <span>Người dùng</span></a></li>
            </ul>
        </div>
        <div class="sidebar-footer">
            <p>Phiên bản 2.0.1</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1><i class="fas fa-play-circle"></i> Quản lý tập phim</h1>
            </div>
            <div class="header-right">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Tìm kiếm tập phim...">
                </div>
                <div class="notification">
                    <i class="fas fa-bell"></i>
                    <div class="notification-badge">3</div>
                </div>
                <div class="user-profile">
                    <div class="user-avatar">AD</div>
                    <div class="user-info">
                        <div class="user-name">Quản trị viên</div>
                        <div class="user-role">Super Admin</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Page Header -->
            <div class="page-header">
                <div class="page-title">Quản lý tập phim</div>
                <div class="page-actions">
                    <button class="btn btn-outline" id="refreshBtn"><i class="fas fa-sync"></i> Làm mới</button>
                    <button class="btn btn-primary" id="addEpisodeBtn"><i class="fas fa-plus"></i> Thêm tập phim</button>
                </div>
            </div>

            <!-- Series Info Card -->
            <div class="series-info" id="seriesInfo">
                <div class="loading">Đang tải thông tin phim...</div>
            </div>

            <!-- Filter Bar -->
            <div class="filter-bar">
                <div class="filter-group">
                    <div class="filter-label">Sắp xếp</div>
                    <select class="filter-select" id="sortSelect">
                        <option value="episode_asc">Tập tăng dần</option>
                        <option value="episode_desc">Tập giảm dần</option>
                        <option value="newest">Mới nhất</option>
                        <option value="oldest">Cũ nhất</option>
                    </select>
                </div>
                <div class="filter-group">
                    <div class="filter-label">Tìm kiếm</div>
                    <input type="text" class="filter-input" id="filterSearch" placeholder="Nhập tên tập phim...">
                </div>
            </div>

            <!-- Episodes Table -->
            <div class="table-container">
                <div class="table-header">
                    <h2 id="episodeCount">Danh sách tập phim</h2>
                    <div>
                        <button class="btn btn-outline"><i class="fas fa-file-export"></i> Xuất Excel</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Tập</th>
                            <th>Thumbnail</th>
                            <th>Tên tập phim</th>
                            <th>Thời lượng</th>
                            <th>Ngày tạo</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="episodesTableBody">
                        <tr>
                            <td colspan="6" class="no-data">Đang tải dữ liệu...</td>
                        </tr>
                    </tbody>
                </table>
                
                <!-- Pagination -->
                <div class="pagination">
                    <div class="pagination-btn" id="prevPage"><i class="fas fa-chevron-left"></i></div>
                    <div class="pagination-btn active">1</div>
                    <div class="pagination-btn">2</div>
                    <div class="pagination-btn">3</div>
                    <div class="pagination-btn">4</div>
                    <div class="pagination-btn">5</div>
                    <div class="pagination-btn" id="nextPage"><i class="fas fa-chevron-right"></i></div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>© 2023 Hệ thống Quản trị Phim. Phiên bản 2.0.1</p>
        </div>
    </div>

    <!-- Add/Edit Episode Modal -->
    <div class="modal" id="episodeModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Thêm tập phim mới</div>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="episodeForm">
                    <div class="form-group">
                        <label class="form-label" for="episodeMovie">Chọn phim *</label>
                        <select class="form-control form-select" id="episodeMovie" required>
                            <option value="">-- Chọn phim --</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="episodeNumber">Số tập *</label>
                        <input type="number" class="form-control" id="episodeNumber" min="1" max="1000" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="episodeTitle">Tên tập phim</label>
                        <input type="text" class="form-control" id="episodeTitle" placeholder="Nhập tên tập phim (nếu có)">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="episodeDuration">Thời lượng (phút)</label>
                        <input type="number" class="form-control" id="episodeDuration" min="1" placeholder="Thời lượng tập phim">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="episodeVideoUrl">Video URL (Google Drive) *</label>
                        <div class="video-preview">
                            <i class="fas fa-video"></i>
                        </div>
                        <input type="text" class="form-control" id="episodeVideoUrl" placeholder="https://drive.google.com/file/d/FILE_ID/view?usp=sharing" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelBtn">Hủy</button>
                <button class="btn btn-primary" id="saveEpisodeBtn">Lưu tập phim</button>
            </div>
        </div>
    </div>

    <script>
        let currentMovieId = new URLSearchParams(window.location.search).get('movie_id');
        let currentEditingEpisodeId = null;

        // Khởi tạo trang
        document.addEventListener('DOMContentLoaded', function() {
            loadMoviesForSelect();
            if (currentMovieId) {
                loadMovieInfo(currentMovieId);
                loadEpisodes(currentMovieId);
            } else {
                loadAllEpisodes();
            }
            
            setupEventListeners();
        });

        // Thiết lập event listeners
        function setupEventListeners() {
            // Search
            document.getElementById('searchInput').addEventListener('input', debounce(handleSearch, 300));
            document.getElementById('filterSearch').addEventListener('input', debounce(handleSearch, 300));
            
            // Sort
            document.getElementById('sortSelect').addEventListener('change', handleSort);
            
            // Refresh
            document.getElementById('refreshBtn').addEventListener('click', refreshData);
            
            // Modal events
            setupModalEvents();
        }

        // Tải danh sách phim cho select
        async function loadMoviesForSelect() {
            try {
                const response = await fetch('/api/movies');
                const movies = await response.json();
                
                const select = document.getElementById('episodeMovie');
                select.innerHTML = '<option value="">-- Chọn phim --</option>';
                
                movies.forEach(movie => {
                    const option = document.createElement('option');
                    option.value = movie.id;
                    option.textContent = movie.title;
                    if (currentMovieId && movie.id == currentMovieId) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading movies:', error);
                alert('Lỗi khi tải danh sách phim');
            }
        }

        // Tải thông tin phim
        async function loadMovieInfo(movieId) {
            try {
                const response = await fetch(`/api/movies/${movieId}`);
                const movie = await response.json();
                
                if (!movie.error) {
                    displayMovieInfo(movie);
                } else {
                    document.getElementById('seriesInfo').innerHTML = '<div class="error">Không tìm thấy thông tin phim</div>';
                }
            } catch (error) {
                console.error('Error loading movie info:', error);
                document.getElementById('seriesInfo').innerHTML = '<div class="error">Lỗi khi tải thông tin phim</div>';
            }
        }

        // Hiển thị thông tin phim
        function displayMovieInfo(movie) {
            const seriesInfo = document.getElementById('seriesInfo');
            const movieType = movie.is_series ? 'Phim bộ' : 'Phim lẻ';
            const posterUrl = movie.poster_url || 'https://via.placeholder.com/120x160/3f51b5/ffffff?text=No+Image';
            const description = movie.description || 'Chưa có mô tả cho phim này.';
            const releaseYear = movie.release_year || 'N/A';
            const duration = movie.duration ? movie.duration + ' phút' : 'N/A';
            const rating = movie.average_rating ? movie.average_rating + '/10' : 'Chưa có';
            const episodeCount = movie.episode_count || 0;
            const viewCount = movie.view_count || 0;
            
            seriesInfo.innerHTML = `
                <img src="${posterUrl}" class="series-poster" alt="${movie.title}">
                <div class="series-details">
                    <div class="series-title">${movie.title}</div>
                    <div class="series-meta">
                        <div class="meta-item">
                            <i class="fas fa-tv"></i>
                            <span>${movieType}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-calendar"></i>
                            <span>${releaseYear}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-clock"></i>
                            <span>${duration}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-star"></i>
                            <span>${rating}</span>
                        </div>
                    </div>
                    <div class="series-description">
                        ${description}
                    </div>
                    <div class="series-stats">
                        <div class="stat-item">
                            <div class="stat-value">${episodeCount}</div>
                            <div class="stat-label">Tập</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${viewCount}</div>
                            <div class="stat-label">Lượt xem</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Tải tập phim
        async function loadEpisodes(movieId = null) {
            try {
                let url = '/api/episodes';
                const params = new URLSearchParams();
                
                if (movieId) params.append('movie_id', movieId);
                
                const searchValue = document.getElementById('filterSearch').value;
                if (searchValue) {
                    params.append('search', searchValue);
                }
                
                params.append('sort_by', document.getElementById('sortSelect').value);
                
                const response = await fetch(`${url}?${params}`);
                const episodes = await response.json();
                
                displayEpisodes(episodes);
            } catch (error) {
                console.error('Error loading episodes:', error);
                document.getElementById('episodesTableBody').innerHTML = `
                    <tr>
                        <td colspan="6" class="error">Lỗi khi tải danh sách tập phim</td>
                    </tr>
                `;
            }
        }

        // Tải tất cả tập phim
        async function loadAllEpisodes() {
            await loadEpisodes(null);
        }

        // Hiển thị tập phim
        function displayEpisodes(episodes) {
            const tbody = document.getElementById('episodesTableBody');
            const episodeCount = document.getElementById('episodeCount');
            
            episodeCount.textContent = `Danh sách tập phim (${episodes.length} tập)`;
            
            if (episodes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="no-data">Không có tập phim nào</td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = episodes.map(episode => `
                <tr>
                    <td><span class="episode-number">${episode.episode_number}</span></td>
                    <td>
                        <div class="episode-thumbnail">
                            <i class="fas fa-play-circle"></i>
                        </div>
                    </td>
                    <td>${episode.title || `Tập ${episode.episode_number}`}</td>
                    <td>${episode.duration ? episode.duration + ' phút' : 'N/A'}</td>
                    <td>${formatDate(episode.created_at)}</td>
                    <td>
                        <div class="action-buttons">
                            <div class="action-btn edit-btn" data-id="${episode.id}">
                                <i class="fas fa-edit"></i>
                            </div>
                            <div class="action-btn delete-btn" data-id="${episode.id}">
                                <i class="fas fa-trash"></i>
                            </div>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            // Thêm event listeners cho các nút
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    editEpisode(this.dataset.id);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    deleteEpisode(this.dataset.id);
                });
            });
        }

        // Định dạng ngày tháng
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN');
        }

        // Xử lý tìm kiếm
        function handleSearch() {
            loadEpisodes(currentMovieId);
        }

        // Xử lý sắp xếp
        function handleSort() {
            loadEpisodes(currentMovieId);
        }

        // Làm mới dữ liệu
        function refreshData() {
            if (currentMovieId) {
                loadMovieInfo(currentMovieId);
                loadEpisodes(currentMovieId);
            } else {
                loadAllEpisodes();
            }
        }

        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Modal functions
        function setupModalEvents() {
            const episodeModal = document.getElementById('episodeModal');
            const addEpisodeBtn = document.getElementById('addEpisodeBtn');
            const closeModal = document.getElementById('closeModal');
            const cancelBtn = document.getElementById('cancelBtn');
            const saveEpisodeBtn = document.getElementById('saveEpisodeBtn');

            addEpisodeBtn.addEventListener('click', function() {
                openAddModal();
            });

            closeModal.addEventListener('click', closeEpisodeModal);
            cancelBtn.addEventListener('click', closeEpisodeModal);

            saveEpisodeBtn.addEventListener('click', saveEpisode);
        }

        function openAddModal() {
            const modalTitle = document.getElementById('modalTitle');
            modalTitle.textContent = 'Thêm tập phim mới';
            currentEditingEpisodeId = null;
            document.getElementById('episodeForm').reset();
            document.getElementById('episodeModal').style.display = 'flex';
        }

        function closeEpisodeModal() {
            document.getElementById('episodeModal').style.display = 'none';
            document.getElementById('episodeForm').reset();
            currentEditingEpisodeId = null;
        }

        async function editEpisode(episodeId) {
            try {
                const response = await fetch(`/api/episodes/${episodeId}`);
                const episode = await response.json();
                
                if (!episode.error) {
                    const modalTitle = document.getElementById('modalTitle');
                    modalTitle.textContent = 'Chỉnh sửa tập phim';
                    
                    document.getElementById('episodeMovie').value = episode.movie_id;
                    document.getElementById('episodeNumber').value = episode.episode_number;
                    document.getElementById('episodeTitle').value = episode.title || '';
                    document.getElementById('episodeDuration').value = episode.duration || '';
                    document.getElementById('episodeVideoUrl').value = episode.video_url || '';
                    
                    currentEditingEpisodeId = episodeId;
                    document.getElementById('episodeModal').style.display = 'flex';
                } else {
                    alert('Không tìm thấy tập phim');
                }
            } catch (error) {
                console.error('Error loading episode:', error);
                alert('Lỗi khi tải thông tin tập phim');
            }
        }

        async function saveEpisode() {
            const formData = {
                movie_id: document.getElementById('episodeMovie').value,
                episode_number: document.getElementById('episodeNumber').value,
                title: document.getElementById('episodeTitle').value,
                duration: document.getElementById('episodeDuration').value,
                video_url: document.getElementById('episodeVideoUrl').value
            };

            if (!formData.movie_id || !formData.episode_number || !formData.video_url) {
                alert('Vui lòng điền đầy đủ thông tin bắt buộc (Phim, số tập và URL video)!');
                return;
            }

            try {
                const url = currentEditingEpisodeId ? 
                    `/api/episodes/${currentEditingEpisodeId}` : '/api/episodes';
                const method = currentEditingEpisodeId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (response.ok) {
                    alert(currentEditingEpisodeId ? 
                        'Cập nhật tập phim thành công!' : 'Thêm tập phim thành công!');
                    closeEpisodeModal();
                    refreshData();
                } else {
                    alert('Lỗi: ' + (result.error || 'Không thể lưu tập phim'));
                }
            } catch (error) {
                console.error('Error saving episode:', error);
                alert('Lỗi khi lưu tập phim');
            }
        }

        async function deleteEpisode(episodeId) {
            if (!confirm('Bạn có chắc chắn muốn xóa tập phim này không?')) {
                return;
            }

            try {
                const response = await fetch(`/api/episodes/${episodeId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    alert('Xóa tập phim thành công!');
                    refreshData();
                } else {
                    alert('Lỗi: ' + (result.error || 'Không thể xóa tập phim'));
                }
            } catch (error) {
                console.error('Error deleting episode:', error);
                alert('Lỗi khi xóa tập phim');
            }
        }

        // Xử lý sự kiện cho sidebar
        document.querySelectorAll('.sidebar-menu a').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.sidebar-menu a').forEach(link => {
                    link.classList.remove('active');
                });
                this.classList.add('active');
            });
        });
    </script>
</body>
</html>