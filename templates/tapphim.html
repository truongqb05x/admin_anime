<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Quản lý Tập Phim</title>
    <link rel="stylesheet" href="../static/css/pages/tapphim.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-film fa-2x"></i>
            <h2>Anime Admin</h2>
        </div>
        <div class="sidebar-menu">
            <ul>
                <li><a href="#"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a></li>
                <li><a href="#" class="active"><i class="fas fa-film"></i> <span>Quản lý Phim</span></a></li>
                <li><a href="#"><i class="fas fa-tags"></i> <span>Blog</span></a></li>
                <li><a href="#"><i class="fas fa-chart-bar"></i> <span>Thống kê</span></a></li>
            </ul>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1>Quản lý Tập Phim</h1>
            </div>
            <div class="header-right">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Tìm kiếm tập phim...">
                </div>
                <div class="user-profile">
                    <div class="user-avatar">AD</div>
                    <span>Admin User</span>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content">
            <!-- Anime Info -->
            <div class="anime-info">
                <img src="https://example.com/poster1.jpg" alt="One Piece: Film Red" class="anime-poster">
                <div class="anime-details">
                    <h3>One Piece: Film Red</h3>
                    <div class="anime-meta">
                        <div class="meta-item">
                            <i class="fas fa-calendar"></i>
                            <span>2022</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-tv"></i>
                            <span>1 tập</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-star"></i>
                            <span>4.5/5</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-eye"></i>
                            <span>245,678 lượt xem</span>
                        </div>
                    </div>
                    <div class="season-selector">
                        <select id="seasonSelect">
                            <option value="1">Mùa 1</option>
                            <option value="2">Mùa 2</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Import Excel Section -->
            <div class="import-section">
                <div class="import-header">
                    <h3>Import Tập Phim từ Excel</h3>
                    <div class="template-download">
                        <button class="btn btn-outline" id="downloadTemplateBtn">
                            <i class="fas fa-download"></i> Tải Template
                        </button>
                    </div>
                </div>
                
                <div class="import-options">
                    <div class="import-option">
                        <div class="file-input-wrapper">
                            <input type="file" id="excelFile" accept=".xlsx, .xls" style="display: none;">
                            <label for="excelFile" class="file-input-label" id="fileInputLabel">
                                <i class="fas fa-file-excel"></i>
                                <span>Chọn file Excel</span>
                                <div class="file-name" id="fileName">Chưa chọn file</div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="import-option">
                        <label for="importAction">Hành động khi import</label>
                        <select id="importAction">
                            <option value="add">Thêm mới</option>
                            <option value="update">Cập nhật (nếu tồn tại)</option>
                            <option value="replace">Thay thế toàn bộ</option>
                        </select>
                    </div>
                    
                    <div class="import-option">
                        <label for="seasonImport">Mùa phim</label>
                        <select id="seasonImport">
                            <option value="1">Mùa 1</option>
                            <option value="2">Mùa 2</option>
                        </select>
                    </div>
                </div>
                
                <div class="batch-actions">
                    <button class="btn btn-primary" id="previewImportBtn" disabled>
                        <i class="fas fa-eye"></i> Xem trước
                    </button>
                    <button class="btn btn-success" id="importBtn" disabled>
                        <i class="fas fa-upload"></i> Import
                    </button>
                    <button class="btn" id="clearImportBtn">
                        <i class="fas fa-times"></i> Hủy
                    </button>
                </div>
                
                <div class="import-progress" id="importProgress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">Đang xử lý...</div>
                </div>
                
                <div id="previewContainer" style="display: none;">
                    <div class="preview-table" id="previewTable"></div>
                    <div id="validationErrors"></div>
                </div>
            </div>

            <div class="page-title">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <h2>Danh sách Tập Phim</h2>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="goBackToAnime()">
                        <i class="fas fa-arrow-left"></i> Quay lại
                    </button>
                    <button class="btn btn-primary" id="addEpisodeBtn">
                        <i class="fas fa-plus"></i> Thêm tập mới
                    </button>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters">
                <div class="filter-group">
                    <label for="episodeFilter">Số tập</label>
                    <select id="episodeFilter">
                        <option value="">Tất cả</option>
                        <option value="1-10">1-10</option>
                        <option value="11-20">11-20</option>
                        <option value="21-30">21-30</option>
                        <option value="31+">31+</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="viewsFilter">Lượt xem</label>
                    <select id="viewsFilter">
                        <option value="">Tất cả</option>
                        <option value="0-1000">0-1,000</option>
                        <option value="1001-5000">1,001-5,000</option>
                        <option value="5001-10000">5,001-10,000</option>
                        <option value="10000+">10,000+</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="sortBy">Sắp xếp</label>
                    <select id="sortBy">
                        <option value="episode_number">Số tập tăng dần</option>
                        <option value="-episode_number">Số tập giảm dần</option>
                        <option value="-views">Lượt xem nhiều nhất</option>
                        <option value="views">Lượt xem ít nhất</option>
                        <option value="-release_date">Mới nhất</option>
                        <option value="release_date">Cũ nhất</option>
                    </select>
                </div>
                <div class="filter-group filter-actions">
                    <label>&nbsp;</label>
                    <div class="filter-buttons">
                        <button class="btn btn-primary" id="applyFiltersBtn">Áp dụng</button>
                        <button class="btn" id="resetFiltersBtn">Đặt lại</button>
                    </div>
                </div>
            </div>

            <!-- Episodes Table -->
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Danh sách tập phim</div>
                    <div>
                        <span id="totalRecords">Hiển thị 0/0 bản ghi</span>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Hình ảnh</th>
                            <th>Tập</th>
                            <th>Tiêu đề</th>
                            <th>Thời lượng</th>
                            <th>Lượt xem</th>
                            <th>Ngày phát hành</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="episodesTableBody">
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
                <div class="pagination" id="pagination">
                    <!-- Pagination will be generated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Episode Modal -->
    <div class="modal" id="episodeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Thêm tập mới</h3>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="episodeForm">
                    <input type="hidden" id="episodeId">
                    <input type="hidden" id="seasonId" value="1">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="episode_number">Số tập *</label>
                            <input type="number" id="episode_number" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="duration">Thời lượng (phút)</label>
                            <input type="number" id="duration" min="1">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="title">Tiêu đề</label>
                        <input type="text" id="title">
                    </div>
                    
                    <div class="form-group">
                        <label for="description">Mô tả</label>
                        <textarea id="description"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="video_url">URL Video *</label>
                            <input type="text" id="video_url" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="release_date">Ngày phát hành</label>
                        <input type="date" id="release_date">
                    </div>
                    
                    <div class="form-group">
                        <label>Xem trước video</label>
                        <div class="video-preview" id="videoPreview">
                            <i class="fas fa-video" style="font-size: 2rem; color: #ccc;"></i>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancelBtn">Hủy</button>
                <button class="btn btn-primary" id="saveEpisodeBtn">Lưu</button>
            </div>
        </div>
    </div>

    <script>
        // Sample data - in a real app, this would come from an API
        const episodesData = [
            {
                id: 1,
                season_id: 1,
                episode_number: 1,
                title: "Luffy vs Kaido - Trận chiến quyết định",
                description: "Trận chiến cuối cùng giữa Luffy và Kaido diễn ra tại Onigashima",
                video_url: "https://example.com/videos/one-piece-ep1.mp4",
                thumbnail_url: "https://example.com/thumbnails/one-piece-ep1.jpg",
                duration: 24,
                views: 12500,
                release_date: "2023-10-15"
            },
            {
                id: 2,
                season_id: 1,
                episode_number: 2,
                title: "Sức mạnh mới của Zoro",
                description: "Zoro thức tỉnh sức mạnh Haki bá vương và thể hiện kỹ năng kiếm thuật đỉnh cao",
                video_url: "https://example.com/videos/one-piece-ep2.mp4",
                thumbnail_url: "https://example.com/thumbnails/one-piece-ep2.jpg",
                duration: 24,
                views: 11800,
                release_date: "2023-10-22"
            },
            {
                id: 3,
                season_id: 1,
                episode_number: 3,
                title: "Bí mật về Quả Ác Quỷ",
                description: "Tiết lộ nguồn gốc thực sự của các Quả Ác Quỷ và mối liên hệ với thế giới cổ đại",
                video_url: "https://example.com/videos/one-piece-ep3.mp4",
                thumbnail_url: "https://example.com/thumbnails/one-piece-ep3.jpg",
                duration: 24,
                views: 13200,
                release_date: "2023-10-29"
            },
            {
                id: 4,
                season_id: 1,
                episode_number: 4,
                title: "Hải tặc Mũ Rơm tái hợp",
                description: "Các thành viên băng Hải tặc Mũ Rơm cuối cùng cũng gặp lại nhau sau 2 năm",
                video_url: "https://example.com/videos/one-piece-ep4.mp4",
                thumbnail_url: "https://example.com/thumbnails/one-piece-ep4.jpg",
                duration: 24,
                views: 14500,
                release_date: "2023-11-05"
            },
            {
                id: 5,
                season_id: 1,
                episode_number: 5,
                title: "Cuộc phiêu lưu mới bắt đầu",
                description: "Băng Mũ Rơm khởi hành đến hòn đảo bí ẩn tiếp theo trong hành trình tìm One Piece",
                video_url: "https://example.com/videos/one-piece-ep5.mp4",
                thumbnail_url: "https://example.com/thumbnails/one-piece-ep5.jpg",
                duration: 24,
                views: 9800,
                release_date: "2023-11-12"
            }
        ];

        // DOM Elements
        const episodesTableBody = document.getElementById('episodesTableBody');
        const episodeModal = document.getElementById('episodeModal');
        const modalTitle = document.getElementById('modalTitle');
        const episodeForm = document.getElementById('episodeForm');
        const addEpisodeBtn = document.getElementById('addEpisodeBtn');
        const closeModal = document.getElementById('closeModal');
        const cancelBtn = document.getElementById('cancelBtn');
        const saveEpisodeBtn = document.getElementById('saveEpisodeBtn');
        const searchInput = document.getElementById('searchInput');
        const episodeFilter = document.getElementById('episodeFilter');
        const viewsFilter = document.getElementById('viewsFilter');
        const sortBy = document.getElementById('sortBy');
        const applyFiltersBtn = document.getElementById('applyFiltersBtn');
        const resetFiltersBtn = document.getElementById('resetFiltersBtn');
        const pagination = document.getElementById('pagination');
        const totalRecords = document.getElementById('totalRecords');
        const seasonSelect = document.getElementById('seasonSelect');
        const videoPreview = document.getElementById('videoPreview');
        const videoUrlInput = document.getElementById('video_url');

        // Import Elements
        const excelFileInput = document.getElementById('excelFile');
        const fileInputLabel = document.getElementById('fileInputLabel');
        const fileName = document.getElementById('fileName');
        const previewImportBtn = document.getElementById('previewImportBtn');
        const importBtn = document.getElementById('importBtn');
        const clearImportBtn = document.getElementById('clearImportBtn');
        const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');
        const importProgress = document.getElementById('importProgress');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const previewContainer = document.getElementById('previewContainer');
        const previewTable = document.getElementById('previewTable');
        const validationErrors = document.getElementById('validationErrors');
        const importAction = document.getElementById('importAction');
        const seasonImport = document.getElementById('seasonImport');

        // Current state
        let currentPage = 1;
        const itemsPerPage = 5;
        let filteredData = [...episodesData];
        let currentExcelData = null;
        let validationResults = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Get anime ID from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const animeId = urlParams.get('anime_id');
            
            if (animeId) {
                // In a real app, you would fetch anime details by ID
                console.log('Loading episodes for anime ID:', animeId);
            }
            
            renderEpisodesTable();
            setupEventListeners();
            setupImportListeners();
        });

        // Setup event listeners
        function setupEventListeners() {
            addEpisodeBtn.addEventListener('click', openAddModal);
            closeModal.addEventListener('click', closeEpisodeModal);
            cancelBtn.addEventListener('click', closeEpisodeModal);
            saveEpisodeBtn.addEventListener('click', saveEpisode);
            searchInput.addEventListener('input', applyFilters);
            applyFiltersBtn.addEventListener('click', applyFilters);
            resetFiltersBtn.addEventListener('click', resetFilters);
            seasonSelect.addEventListener('change', changeSeason);
            videoUrlInput.addEventListener('input', updateVideoPreview);
            
            // Close modal when clicking outside
            window.addEventListener('click', function(event) {
                if (event.target === episodeModal) {
                    closeEpisodeModal();
                }
            });
        }

        // Setup import listeners
        function setupImportListeners() {
            excelFileInput.addEventListener('change', handleFileSelect);
            previewImportBtn.addEventListener('click', previewImport);
            importBtn.addEventListener('click', processImport);
            clearImportBtn.addEventListener('click', clearImport);
            downloadTemplateBtn.addEventListener('click', downloadTemplate);
        }

        // Handle file selection
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                fileName.textContent = file.name;
                fileInputLabel.classList.add('has-file');
                previewImportBtn.disabled = false;
                importBtn.disabled = false;
                currentExcelData = null;
                previewContainer.style.display = 'none';
            } else {
                fileName.textContent = 'Chưa chọn file';
                fileInputLabel.classList.remove('has-file');
                previewImportBtn.disabled = true;
                importBtn.disabled = true;
            }
        }

        // Preview import data
        function previewImport() {
            const file = excelFileInput.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Get first worksheet
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                if (jsonData.length < 2) {
                    alert('File Excel không có dữ liệu hoặc định dạng không đúng!');
                    return;
                }
                
                // Validate header
                const headers = jsonData[0];
                const expectedHeaders = ['Số tập', 'Tiêu đề', 'Mô tả', 'URL Video', 'Thời lượng (phút)', 'Ngày phát hành (YYYY-MM-DD)'];
                
                if (!arraysEqual(headers, expectedHeaders)) {
                    alert(`Định dạng file không đúng. Các cột cần có: ${expectedHeaders.join(', ')}`);
                    return;
                }
                
                // Process data
                const episodes = [];
                const errors = [];
                
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (row.length === 0) continue;
                    
                    const episode = {
                        episode_number: parseInt(row[0]),
                        title: row[1] || '',
                        description: row[2] || '',
                        video_url: row[3] || '',
                        duration: parseInt(row[4]) || 0,
                        release_date: row[5] || ''
                    };
                    
                    // Validate episode
                    const validation = validateEpisode(episode, i);
                    if (validation.isValid) {
                        episodes.push(episode);
                    } else {
                        errors.push({
                            row: i + 1,
                            errors: validation.errors
                        });
                    }
                }
                
                currentExcelData = episodes;
                validationResults = {
                    episodes: episodes,
                    errors: errors
                };
                
                displayPreview(episodes, errors);
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Validate episode data
        function validateEpisode(episode, rowIndex) {
            const errors = [];
            
            if (!episode.episode_number || isNaN(episode.episode_number) || episode.episode_number < 1) {
                errors.push('Số tập không hợp lệ');
            }
            
            if (!episode.video_url) {
                errors.push('URL Video là bắt buộc');
            }
            
            if (episode.duration && (isNaN(episode.duration) || episode.duration < 1)) {
                errors.push('Thời lượng không hợp lệ');
            }
            
            if (episode.release_date && !isValidDate(episode.release_date)) {
                errors.push('Ngày phát hành không hợp lệ (định dạng YYYY-MM-DD)');
            }
            
            // Check for duplicate episode numbers
            if (episodesData.some(e => e.episode_number === episode.episode_number && e.season_id === parseInt(seasonImport.value))) {
                errors.push('Số tập đã tồn tại');
            }
            
            return {
                isValid: errors.length === 0,
                errors: errors
            };
        }

        // Check if date is valid
        function isValidDate(dateString) {
            const regex = /^\d{4}-\d{2}-\d{2}$/;
            if (!dateString.match(regex)) return false;
            
            const date = new Date(dateString);
            const timestamp = date.getTime();
            
            if (typeof timestamp !== 'number' || isNaN(timestamp)) return false;
            
            return date.toISOString().slice(0, 10) === dateString;
        }

        // Check if two arrays are equal
        function arraysEqual(a, b) {
            if (a.length !== b.length) return false;
            for (let i = 0; i < a.length; i++) {
                if (a[i] !== b[i]) return false;
            }
            return true;
        }

        // Display preview of import data
        function displayPreview(episodes, errors) {
            previewContainer.style.display = 'block';
            
            // Create preview table
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Số tập</th>
                            <th>Tiêu đề</th>
                            <th>Mô tả</th>
                            <th>URL Video</th>
                            <th>Thời lượng</th>
                            <th>Ngày phát hành</th>
                            <th>Trạng thái</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            episodes.forEach((episode, index) => {
                const error = errors.find(e => e.row === index + 2);
                const rowClass = error ? 'error-row' : '';
                
                tableHTML += `
                    <tr class="${rowClass}">
                        <td>${episode.episode_number}</td>
                        <td>${episode.title || '-'}</td>
                        <td>${episode.description ? truncateText(episode.description, 30) : '-'}</td>
                        <td>${truncateText(episode.video_url, 30)}</td>
                        <td>${episode.duration || '-'}</td>
                        <td>${episode.release_date || '-'}</td>
                        <td>${error ? '<span style="color: red;">Lỗi</span>' : '<span style="color: green;">OK</span>'}</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            previewTable.innerHTML = tableHTML;
            
            // Display validation errors
            if (errors.length > 0) {
                let errorsHTML = '<h4>Lỗi kiểm tra:</h4><ul>';
                errors.forEach(error => {
                    errorsHTML += `<li>Dòng ${error.row}: ${error.errors.join(', ')}</li>`;
                });
                errorsHTML += '</ul>';
                validationErrors.innerHTML = errorsHTML;
            } else {
                validationErrors.innerHTML = '<p style="color: green;">Tất cả dữ liệu đều hợp lệ!</p>';
            }
        }

        // Process import
        function processImport() {
            if (!currentExcelData || currentExcelData.length === 0) {
                alert('Không có dữ liệu để import!');
                return;
            }
            
            const action = importAction.value;
            const seasonId = parseInt(seasonImport.value);
            
            importProgress.style.display = 'block';
            progressFill.style.width = '0%';
            progressText.textContent = 'Đang xử lý...';
            
            let processed = 0;
            const total = currentExcelData.length;
            const newEpisodes = [];
            
            // Simulate import process
            const importInterval = setInterval(() => {
                processed++;
                const progress = (processed / total) * 100;
                progressFill.style.width = `${progress}%`;
                progressText.textContent = `Đang xử lý ${processed}/${total} tập phim...`;
                
                if (processed === total) {
                    clearInterval(importInterval);
                    
                    // Add episodes to data
                    currentExcelData.forEach(episode => {
                        const newEpisode = {
                            id: episodesData.length > 0 ? Math.max(...episodesData.map(e => e.id)) + 1 : 1,
                            season_id: seasonId,
                            episode_number: episode.episode_number,
                            title: episode.title,
                            description: episode.description,
                            video_url: episode.video_url,
                            thumbnail_url: '', // You might want to generate thumbnails
                            duration: episode.duration,
                            views: 0,
                            release_date: episode.release_date
                        };
                        
                        if (action === 'update') {
                            // Update if exists, otherwise add
                            const existingIndex = episodesData.findIndex(
                                e => e.episode_number === episode.episode_number && e.season_id === seasonId
                            );
                            
                            if (existingIndex !== -1) {
                                episodesData[existingIndex] = {
                                    ...episodesData[existingIndex],
                                    ...newEpisode,
                                    id: episodesData[existingIndex].id // Keep original ID
                                };
                            } else {
                                episodesData.push(newEpisode);
                            }
                        } else if (action === 'replace') {
                            // Replace all episodes for this season
                            // First remove existing episodes for this season
                            const filteredEpisodes = episodesData.filter(e => e.season_id !== seasonId);
                            episodesData.length = 0;
                            episodesData.push(...filteredEpisodes);
                            
                            // Add new episodes
                            currentExcelData.forEach((ep, index) => {
                                episodesData.push({
                                    ...newEpisode,
                                    id: episodesData.length > 0 ? Math.max(...episodesData.map(e => e.id)) + 1 : 1,
                                    episode_number: ep.episode_number
                                });
                            });
                        } else {
                            // Add new episodes
                            episodesData.push(newEpisode);
                        }
                    });
                    
                    progressText.textContent = 'Import hoàn tất!';
                    
                    // Refresh table
                    setTimeout(() => {
                        importProgress.style.display = 'none';
                        clearImport();
                        renderEpisodesTable();
                        alert(`Đã import thành công ${currentExcelData.length} tập phim!`);
                    }, 1000);
                }
            }, 100);
        }

        // Clear import
        function clearImport() {
            excelFileInput.value = '';
            fileName.textContent = 'Chưa chọn file';
            fileInputLabel.classList.remove('has-file');
            previewImportBtn.disabled = true;
            importBtn.disabled = true;
            previewContainer.style.display = 'none';
            currentExcelData = null;
            validationResults = null;
        }

        // Download template
        function downloadTemplate() {
            // Create template data
            const templateData = [
                ['Số tập', 'Tiêu đề', 'Mô tả', 'URL Video', 'Thời lượng (phút)', 'Ngày phát hành (YYYY-MM-DD)'],
                [1, 'Tập 1: Tiêu đề tập phim', 'Mô tả tập phim', 'https://example.com/video1.mp4', 24, '2023-10-15'],
                [2, 'Tập 2: Tiêu đề tập phim', 'Mô tả tập phim', 'https://example.com/video2.mp4', 24, '2023-10-22']
            ];
            
            // Create worksheet
            const worksheet = XLSX.utils.aoa_to_sheet(templateData);
            
            // Create workbook
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Template');
            
            // Generate and download file
            XLSX.writeFile(workbook, 'template_tap_phim.xlsx');
        }

        // Render episodes table
        function renderEpisodesTable() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentData = filteredData.slice(startIndex, endIndex);
            
            episodesTableBody.innerHTML = '';
            
            if (currentData.length === 0) {
                episodesTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center;">Không có dữ liệu</td>
                    </tr>
                `;
                return;
            }
            
            currentData.forEach(episode => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <img src="${episode.thumbnail_url || 'https://via.placeholder.com/80x45?text=No+Thumb'}" 
                             alt="${episode.title}" class="thumbnail">
                    </td>
                    <td><strong>Tập ${episode.episode_number}</strong></td>
                    <td>
                        <div>${episode.title || 'Không có tiêu đề'}</div>
                        ${episode.description ? `<div style="font-size: 0.8rem; color: #666; margin-top: 5px;">${truncateText(episode.description, 50)}</div>` : ''}
                    </td>
                    <td class="duration">${episode.duration} phút</td>
                    <td class="views">${formatNumber(episode.views)}</td>
                    <td>${formatDate(episode.release_date)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn preview" onclick="previewVideo('${episode.video_url}')">
                                <i class="fas fa-play"></i> Xem
                            </button>
                            <button class="action-btn edit" onclick="editEpisode(${episode.id})">
                                <i class="fas fa-edit"></i> Sửa
                            </button>
                            <button class="action-btn delete" onclick="deleteEpisode(${episode.id})">
                                <i class="fas fa-trash"></i> Xóa
                            </button>
                        </div>
                    </td>
                `;
                episodesTableBody.appendChild(row);
            });
            
            updatePagination();
            updateTotalRecords();
        }

        // Truncate text
        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        // Format number with commas
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'Chưa xác định';
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN');
        }

        // Update pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            
            pagination.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevBtn.disabled = currentPage === 1;
            prevBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderEpisodesTable();
                }
            });
            pagination.appendChild(prevBtn);
            
            // Page buttons
            for (let i = 1; i <= totalPages; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.classList.toggle('active', i === currentPage);
                pageBtn.addEventListener('click', () => {
                    currentPage = i;
                    renderEpisodesTable();
                });
                pagination.appendChild(pageBtn);
            }
            
            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderEpisodesTable();
                }
            });
            pagination.appendChild(nextBtn);
        }

        // Update total records text
        function updateTotalRecords() {
            const startIndex = (currentPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(currentPage * itemsPerPage, filteredData.length);
            totalRecords.textContent = `Hiển thị ${startIndex}-${endIndex} của ${filteredData.length} bản ghi`;
        }

        // Apply filters
        function applyFilters() {
            const searchTerm = searchInput.value.toLowerCase();
            const episodeValue = episodeFilter.value;
            const viewsValue = viewsFilter.value;
            const sortValue = sortBy.value;
            
            filteredData = episodesData.filter(episode => {
                const matchesSearch = episode.title.toLowerCase().includes(searchTerm) || 
                                    (episode.description && episode.description.toLowerCase().includes(searchTerm));
                
                let matchesEpisode = true;
                if (episodeValue) {
                    if (episodeValue === '1-10') {
                        matchesEpisode = episode.episode_number >= 1 && episode.episode_number <= 10;
                    } else if (episodeValue === '11-20') {
                        matchesEpisode = episode.episode_number >= 11 && episode.episode_number <= 20;
                    } else if (episodeValue === '21-30') {
                        matchesEpisode = episode.episode_number >= 21 && episode.episode_number <= 30;
                    } else if (episodeValue === '31+') {
                        matchesEpisode = episode.episode_number >= 31;
                    }
                }
                
                let matchesViews = true;
                if (viewsValue) {
                    if (viewsValue === '0-1000') {
                        matchesViews = episode.views >= 0 && episode.views <= 1000;
                    } else if (viewsValue === '1001-5000') {
                        matchesViews = episode.views >= 1001 && episode.views <= 5000;
                    } else if (viewsValue === '5001-10000') {
                        matchesViews = episode.views >= 5001 && episode.views <= 10000;
                    } else if (viewsValue === '10000+') {
                        matchesViews = episode.views >= 10000;
                    }
                }
                
                return matchesSearch && matchesEpisode && matchesViews;
            });
            
            // Sort data
            if (sortValue) {
                const [field, direction] = sortValue.startsWith('-') ? 
                    [sortValue.substring(1), 'desc'] : [sortValue, 'asc'];
                
                filteredData.sort((a, b) => {
                    let aVal = a[field];
                    let bVal = b[field];
                    
                    if (typeof aVal === 'string') {
                        aVal = aVal.toLowerCase();
                        bVal = bVal.toLowerCase();
                    }
                    
                    if (aVal < bVal) return direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }
            
            currentPage = 1;
            renderEpisodesTable();
        }

        // Reset filters
        function resetFilters() {
            searchInput.value = '';
            episodeFilter.value = '';
            viewsFilter.value = '';
            sortBy.value = 'episode_number';
            applyFilters();
        }

        // Change season
        function changeSeason() {
            const seasonId = seasonSelect.value;
            console.log('Changing to season:', seasonId);
            // In a real app, you would fetch episodes for the selected season
            // For now, we'll just show an alert
            alert(`Đang tải tập phim cho mùa ${seasonId}`);
            applyFilters();
        }

        // Open add modal
        function openAddModal() {
            modalTitle.textContent = 'Thêm tập mới';
            episodeForm.reset();
            document.getElementById('episodeId').value = '';
            videoPreview.innerHTML = '<i class="fas fa-video" style="font-size: 2rem; color: #ccc;"></i>';
            episodeModal.style.display = 'flex';
        }

        // Close modal
        function closeEpisodeModal() {
            episodeModal.style.display = 'none';
        }

        // Update video preview
        function updateVideoPreview() {
            const videoUrl = videoUrlInput.value;
            
            if (videoUrl) {
                videoPreview.innerHTML = `
                    <video controls>
                        <source src="${videoUrl}" type="video/mp4">
                        Trình duyệt của bạn không hỗ trợ video.
                    </video>
                `;
            } else {
                videoPreview.innerHTML = '<i class="fas fa-video" style="font-size: 2rem; color: #ccc;"></i>';
            }
        }

        // Edit episode
        function editEpisode(id) {
            const episode = episodesData.find(e => e.id === id);
            if (!episode) return;
            
            modalTitle.textContent = 'Chỉnh sửa tập phim';
            document.getElementById('episodeId').value = episode.id;
            document.getElementById('seasonId').value = episode.season_id;
            document.getElementById('episode_number').value = episode.episode_number;
            document.getElementById('duration').value = episode.duration;
            document.getElementById('title').value = episode.title || '';
            document.getElementById('description').value = episode.description || '';
            document.getElementById('video_url').value = episode.video_url;
            document.getElementById('thumbnail_url').value = episode.thumbnail_url || '';
            document.getElementById('release_date').value = episode.release_date || '';
            
            updateVideoPreview();
            episodeModal.style.display = 'flex';
        }

        // Save episode (add or update)
        function saveEpisode() {
            const id = document.getElementById('episodeId').value;
            const episodeNumber = document.getElementById('episode_number').value;
            const videoUrl = document.getElementById('video_url').value;
            
            if (!episodeNumber || !videoUrl) {
                alert('Vui lòng nhập số tập và URL video');
                return;
            }
            
            const episodeData = {
                season_id: parseInt(document.getElementById('seasonId').value),
                episode_number: parseInt(episodeNumber),
                duration: parseInt(document.getElementById('duration').value) || 0,
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                video_url: videoUrl,
                thumbnail_url: document.getElementById('thumbnail_url').value,
                release_date: document.getElementById('release_date').value
            };
            
            if (id) {
                // Update existing episode
                console.log('Cập nhật tập phim:', id, episodeData);
                alert('Đã cập nhật tập phim thành công!');
            } else {
                // Add new episode
                console.log('Thêm tập phim mới:', episodeData);
                alert('Đã thêm tập phim mới thành công!');
            }
            
            closeEpisodeModal();
            // In a real app, you would refresh the data from the server
            // For now, we'll just re-render the table
            renderEpisodesTable();
        }

        // Delete episode
        function deleteEpisode(id) {
            if (confirm('Bạn có chắc chắn muốn xóa tập phim này không?')) {
                console.log('Xóa tập phim với ID:', id);
                alert('Đã xóa tập phim thành công!');
                // In a real app, you would send a delete request to the server
                // For now, we'll just re-render the table
                renderEpisodesTable();
            }
        }

        // Preview video
        function previewVideo(videoUrl) {
            // In a real app, this would open a video player modal
            // For now, we'll just open the video in a new tab
            window.open(videoUrl, '_blank');
        }

        // Go back to anime list
        function goBackToAnime() {
            window.location.href = 'bophim.html';
        }
    </script>
</body>
</html>