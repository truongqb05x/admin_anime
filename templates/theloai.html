<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý thể loại - Hệ thống quản trị phim</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="../static/css/theloai.css">
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2><i class="fas fa-film"></i> Quản trị phim</h2>
        </div>
        <div class="sidebar-menu">
            <ul>
                <li><a href="dashboard.html"><i class="fas fa-home"></i> <span>Tổng quan</span></a></li>
                <li><a href="movies.html"><i class="fas fa-video"></i> <span>Quản lý phim</span></a></li>
                <li><a href="actors.html"><i class="fas fa-theater-masks"></i> <span>Diễn viên</span></a></li>
                <li><a href="#" class="active"><i class="fas fa-list"></i> <span>Thể loại</span></a></li>
                <li><a href="countries.html"><i class="fas fa-globe"></i> <span>Quốc gia</span></a></li>
                <li><a href="episodes.html"><i class="fas fa-play-circle"></i> <span>Tập phim</span></a></li>
                <li><a href="users.html"><i class="fas fa-users"></i> <span>Người dùng</span></a></li>
            </ul>
        </div>
        <div class="sidebar-footer">
            <p>Phiên bản 2.0.1</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1><i class="fas fa-list"></i> Quản lý thể loại</h1>
            </div>
            <div class="header-right">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Tìm kiếm thể loại...">
                </div>
                <div class="notification">
                    <i class="fas fa-bell"></i>
                    <div class="notification-badge">2</div>
                </div>
                <div class="user-profile">
                    <div class="user-avatar">AD</div>
                    <div class="user-info">
                        <div class="user-name">Quản trị viên</div>
                        <div class="user-role">Super Admin</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Page Header -->
            <div class="page-header">
                <div class="page-title">Quản lý thể loại phim</div>
                <div class="page-actions">
                    <button class="btn btn-outline"><i class="fas fa-chart-bar"></i> Thống kê</button>
                    <button class="btn btn-primary" id="addGenreBtn"><i class="fas fa-plus"></i> Thêm thể loại</button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-cards">
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, var(--primary), var(--primary-light));">
                        <i class="fas fa-list"></i>
                    </div>
                    <div class="stat-value" id="totalGenres">0</div>
                    <div class="stat-label">Tổng thể loại</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, var(--success), #66bb6a);">
                        <i class="fas fa-film"></i>
                    </div>
                    <div class="stat-value" id="totalMovies">0</div>
                    <div class="stat-label">Phim có thể loại</div>
                </div>
            </div>

            <!-- Filter Bar -->
            <div class="filter-bar">
                <div class="filter-group">
                    <div class="filter-label">Sắp xếp</div>
                    <select class="filter-select" id="sortSelect">
                        <option value="name_asc">Tên A-Z</option>
                        <option value="name_desc">Tên Z-A</option>
                        <option value="movies_asc">Phim ít nhất</option>
                        <option value="movies_desc">Phim nhiều nhất</option>
                        <option value="newest">Mới nhất</option>
                        <option value="oldest">Cũ nhất</option>
                    </select>
                </div>
                <div class="filter-group">
                    <div class="filter-label">Tìm kiếm</div>
                    <input type="text" class="filter-input" id="searchInput" placeholder="Nhập tên thể loại...">
                </div>
            </div>

            <!-- Genres Table -->
            <div class="table-container">
                <div class="table-header">
                    <h2 id="genreCount">Danh sách thể loại</h2>
                    <div>
                        <button class="btn btn-outline"><i class="fas fa-file-export"></i> Xuất Excel</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Tên thể loại</th>
                            <th>Mô tả</th>
                            <th>Số phim</th>
                            <th>Lượt xem</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="genresTableBody">
                        <!-- Genres will be populated dynamically -->
                    </tbody>
                </table>
                
                <!-- Pagination -->
                <div class="pagination" id="pagination">
                    <!-- Pagination buttons will be populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>© 2023 Hệ thống Quản trị Phim. Phiên bản 2.0.1</p>
        </div>
    </div>

    <!-- Add/Edit Genre Modal -->
    <div class="modal" id="genreModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Thêm thể loại mới</div>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="genreForm">
                    <div class="form-group">
                        <label class="form-label" for="genreName">Tên thể loại *</label>
                        <input type="text" class="form-control" id="genreName" required placeholder="Nhập tên thể loại">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="genreDescription">Mô tả</label>
                        <textarea class="form-control form-textarea" id="genreDescription" placeholder="Mô tả về thể loại này"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelBtn">Hủy</button>
                <button class="btn btn-primary" id="saveGenreBtn">Lưu thể loại</button>
            </div>
        </div>
    </div>

    <script>
        let currentGenreId = null;

        // Fetch and display genres
        function fetchGenres(page = 1, sort = 'name_asc', search = '') {
            $.ajax({
                url: '/api/genres',
                method: 'GET',
                success: function(data) {
                    const genres = data;
                    $('#genresTableBody').empty();
                    $('#totalGenres').text(genres.length);
                    $('#genreCount').text(`Danh sách thể loại (${genres.length} thể loại)`);

                    let totalMovies = 0;
                    genres.forEach(genre => {
                        totalMovies += genre.movie_count;
                        $('#genresTableBody').append(`
                            <tr data-id="${genre.id}">
                                <td>${genre.name}</td>
                                <td>${genre.description || ''}</td>
                                <td>${genre.movie_count}</td>
                                <td>${genre.view_count || 0}</td>
                                <td>
                                    <div class="action-buttons">
                                        <div class="action-btn edit-btn" data-id="${genre.id}"><i class="fas fa-edit"></i></div>
                                        <div class="action-btn delete-btn" data-id="${genre.id}"><i class="fas fa-trash"></i></div>
                                    </div>
                                </td>
                            </tr>
                        `);
                    });
                    $('#totalMovies').text(totalMovies);

                    // Simple pagination (for demo, assuming 10 items per page)
                    const totalPages = Math.ceil(genres.length / 10);
                    $('#pagination').empty();
                    if (totalPages > 1) {
                        $('#pagination').append('<div class="pagination-btn"><i class="fas fa-chevron-left"></i></div>');
                        for (let i = 1; i <= totalPages; i++) {
                            $('#pagination').append(`<div class="pagination-btn ${i === page ? 'active' : ''}">${i}</div>`);
                        }
                        $('#pagination').append('<div class="pagination-btn"><i class="fas fa-chevron-right"></i></div>');
                    }
                },
                error: function(xhr) {
                    alert('Không thể tải danh sách thể loại: ' + xhr.responseJSON.error);
                }
            });
        }

        // Sidebar menu handling
        $('.sidebar-menu a').on('click', function() {
            $('.sidebar-menu a').removeClass('active');
            $(this).addClass('active');
        });

        // Modal handling
        const genreModal = $('#genreModal');
        const addGenreBtn = $('#addGenreBtn');
        const closeModal = $('#closeModal');
        const cancelBtn = $('#cancelBtn');
        const saveGenreBtn = $('#saveGenreBtn');
        const modalTitle = $('#modalTitle');

        // Open modal for adding genre
        addGenreBtn.on('click', function() {
            modalTitle.text('Thêm thể loại mới');
            $('#genreForm')[0].reset();
            currentGenreId = null;
            genreModal.css('display', 'flex');
        });

        // Close modal
        function closeGenreModal() {
            genreModal.css('display', 'none');
            $('#genreForm')[0].reset();
            currentGenreId = null;
        }

        closeModal.on('click', closeGenreModal);
        cancelBtn.on('click', closeGenreModal);

        // Save genre (add or update)
        saveGenreBtn.on('click', function() {
            const name = $('#genreName').val();
            const description = $('#genreDescription').val();
            
            if (!name) {
                alert('Vui lòng nhập tên thể loại!');
                return;
            }

            const data = { name, description };
            const url = currentGenreId ? `/api/genres/${currentGenreId}` : '/api/genres';
            const method = currentGenreId ? 'PUT' : 'POST';

            $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    alert(response.message);
                    closeGenreModal();
                    fetchGenres();
                },
                error: function(xhr) {
                    alert('Lỗi: ' + xhr.responseJSON.error);
                }
            });
        });

        // Edit genre
        $(document).on('click', '.edit-btn', function() {
            currentGenreId = $(this).data('id');
            const row = $(this).closest('tr');
            const name = row.find('td:eq(0)').text();
            const description = row.find('td:eq(1)').text();

            modalTitle.text('Chỉnh sửa thể loại');
            $('#genreName').val(name);
            $('#genreDescription').val(description);
            genreModal.css('display', 'flex');
        });

        // Delete genre
        $(document).on('click', '.delete-btn', function() {
            const id = $(this).data('id');
            const name = $(this).closest('tr').find('td:eq(0)').text();

            if (confirm(`Bạn có chắc chắn muốn xóa thể loại "${name}" không?`)) {
                $.ajax({
                    url: `/api/genres/${id}`,
                    method: 'DELETE',
                    success: function(response) {
                        alert(response.message);
                        fetchGenres();
                    },
                    error: function(xhr) {
                        alert('Lỗi: ' + xhr.responseJSON.error);
                    }
                });
            }
        });

        // Initial fetch
        fetchGenres();
    </script>
</body>
</html>