<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý phim - Hệ thống quản trị phim</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="../static/css/qyanlyphim.css">
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2><i class="fas fa-film"></i> Quản trị phim</h2>
        </div>
        <div class="sidebar-menu">
            <ul>
                <li><a href="dashboard.html"><i class="fas fa-home"></i> <span>Tổng quan</span></a></li>
                <li><a href="#" class="active"><i class="fas fa-video"></i> <span>Quản lý phim</span></a></li>
                <li><a href="actors.html"><i class="fas fa-theater-masks"></i> <span>Diễn viên</span></a></li>
                <li><a href="genres.html"><i class="fas fa-list"></i> <span>Thể loại</span></a></li>
                <li><a href="countries.html"><i class="fas fa-globe"></i> <span>Quốc gia</span></a></li>
                <li><a href="episodes.html"><i class="fas fa-play-circle"></i> <span>Tập phim</span></a></li>
                <li><a href="users.html"><i class="fas fa-users"></i> <span>Người dùng</span></a></li>
            </ul>
        </div>
        <div class="sidebar-footer">
            <p>Phiên bản 2.0.1</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1><i class="fas fa-video"></i> Quản lý phim</h1>
            </div>
            <div class="header-right">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Tìm kiếm phim...">
                </div>
                <div class="notification">
                    <i class="fas fa-bell"></i>
                    <div class="notification-badge">5</div>
                </div>
                <div class="user-profile">
                    <div class="user-avatar">AD</div>
                    <div class="user-info">
                        <div class="user-name">Quản trị viên</div>
                        <div class="user-role">Super Admin</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Page Header -->
            <div class="page-header">
                <div class="page-title">Danh sách phim</div>
                <div class="page-actions">
                    <button class="btn btn-outline" id="filterBtn"><i class="fas fa-filter"></i> Lọc</button>
                    <button class="btn btn-primary" id="addMovieBtn"><i class="fas fa-plus"></i> Thêm phim mới</button>
                </div>
            </div>

            <!-- Filter Bar -->
            <div class="filter-bar">
                <div class="filter-group">
                    <div class="filter-label">Thể loại</div>
                    <select class="filter-select" id="genreFilter">
                        <option value="">Tất cả thể loại</option>
                    </select>
                </div>
                <div class="filter-group">
                    <div class="filter-label">Quốc gia</div>
                    <select class="filter-select" id="countryFilter">
                        <option value="">Tất cả quốc gia</option>
                    </select>
                </div>
                <div class="filter-group">
                    <div class="filter-label">Năm phát hành</div>
                    <select class="filter-select" id="yearFilter">
                        <option value="">Tất cả năm</option>
                    </select>
                </div>
                <div class="filter-group">
                    <div class="filter-label">Loại phim</div>
                    <select class="filter-select" id="typeFilter">
                        <option value="">Tất cả loại</option>
                        <option value="movie">Phim lẻ</option>
                        <option value="series">Phim bộ</option>
                    </select>
                </div>
            </div>

            <!-- Movies Table -->
            <div class="table-container">
                <div class="table-header">
                    <h2 id="movieCount">Danh sách phim</h2>
                    <div>
                        <button class="btn btn-outline" id="exportBtn"><i class="fas fa-file-export"></i> Xuất Excel</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Poster</th>
                            <th>Tên phim</th>
                            <th>Thể loại</th>
                            <th>Năm</th>
                            <th>Đánh giá</th>
                            <th>Lượt xem</th>
                            <th>Loại</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="moviesTableBody">
                        <tr>
                            <td colspan="8" class="no-data">Đang tải dữ liệu...</td>
                        </tr>
                    </tbody>
                </table>
                
                <!-- Pagination -->
                <div class="pagination">
                    <div class="pagination-btn" id="prevPage"><i class="fas fa-chevron-left"></i></div>
                    <div class="pagination-btn active">1</div>
                    <div class="pagination-btn">2</div>
                    <div class="pagination-btn">3</div>
                    <div class="pagination-btn">4</div>
                    <div class="pagination-btn">5</div>
                    <div class="pagination-btn" id="nextPage"><i class="fas fa-chevron-right"></i></div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>© 2023 Hệ thống Quản trị Phim. Phiên bản 2.0.1</p>
        </div>
    </div>

    <!-- Add/Edit Movie Modal -->
    <div class="modal" id="movieModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Thêm phim mới</div>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="movieForm" enctype="multipart/form-data">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="movieTitle">Tên phim *</label>
                                <input type="text" class="form-control" id="movieTitle" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="movieSlug">Slug *</label>
                                <input type="text" class="form-control" id="movieSlug" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="movieDescription">Mô tả</label>
                        <textarea class="form-control form-textarea" id="movieDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="movieMetaDescription">Meta Description</label>
                        <textarea class="form-control form-textarea" id="movieMetaDescription" rows="2"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="movieReleaseYear">Năm phát hành</label>
                                <input type="number" class="form-control" id="movieReleaseYear" min="1900" max="2030">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="movieDuration">Thời lượng (phút)</label>
                                <input type="number" class="form-control" id="movieDuration" min="1">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="moviePosterFile">Tệp Poster</label>
                                <input type="file" class="form-control" id="moviePosterFile" accept="image/*">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="movieTrailerUrl">URL Trailer</label>
                                <input type="text" class="form-control" id="movieTrailerUrl" placeholder="https://youtube.com/...">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="movieVideoUrl">URL Video (Google Drive)</label>
                        <input type="text" class="form-control" id="movieVideoUrl" placeholder="https://drive.google.com/file/d/FILE_ID/view?usp=sharing">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="movieGenres">Thể loại</label>
                                <select class="form-control form-select" id="movieGenres" multiple>
                                    <option value="1">Hành động</option>
                                    <option value="2">Lãng mạn</option>
                                    <option value="3">Hài</option>
                                    <option value="4">Kinh dị</option>
                                    <option value="5">Khoa học viễn tưởng</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="movieCountries">Quốc gia</label>
                                <select class="form-control form-select" id="movieCountries" multiple>
                                    <option value="1">Mỹ</option>
                                    <option value="2">Hàn Quốc</option>
                                    <option value="3">Trung Quốc</option>
                                    <option value="4">Nhật Bản</option>
                                    <option value="5">Việt Nam</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="movieActors">Diễn viên</label>
                        <select class="form-control form-select" id="movieActors" multiple>
                            <option value="1">Robert Downey Jr.</option>
                            <option value="2">Chris Evans</option>
                            <option value="3">Scarlett Johansson</option>
                            <option value="4">Tom Holland</option>
                            <option value="5">Zendaya</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <div class="form-checkbox">
                                    <input type="checkbox" id="movieIsSeries">
                                    <label class="form-label" for="movieIsSeries">Là phim bộ</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <div class="form-checkbox">
                                    <input type="checkbox" id="movieIsFeatured">
                                    <label class="form-label" for="movieIsFeatured">Phim nổi bật</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelBtn">Hủy</button>
                <button class="btn btn-primary" id="saveMovieBtn">Lưu phim</button>
            </div>
        </div>
    </div>

    <script>
        let currentEditingMovieId = null;

        // Khởi tạo trang
        document.addEventListener('DOMContentLoaded', function() {
            loadMovies();
            setupEventListeners();
            
            // Tự động tạo slug từ tên phim
            document.getElementById('movieTitle').addEventListener('input', function() {
                const title = this.value;
                const slug = title.toLowerCase()
                    .replace(/[^\w\s]/gi, '')
                    .replace(/\s+/g, '-');
                document.getElementById('movieSlug').value = slug;
            });
        });

        // Thiết lập event listeners
        function setupEventListeners() {
            // Search
            document.getElementById('searchInput').addEventListener('input', debounce(loadMovies, 300));
            
            // Filters
            document.getElementById('genreFilter').addEventListener('change', loadMovies);
            document.getElementById('countryFilter').addEventListener('change', loadMovies);
            document.getElementById('yearFilter').addEventListener('change', loadMovies);
            document.getElementById('typeFilter').addEventListener('change', loadMovies);
            
            // Buttons
            document.getElementById('addMovieBtn').addEventListener('click', openAddModal);
            document.getElementById('exportBtn').addEventListener('click', exportToExcel);
            
            // Modal events
            setupModalEvents();
        }

        // Tải danh sách phim
        async function loadMovies() {
            try {
                const params = new URLSearchParams();
                
                const genreFilter = document.getElementById('genreFilter').value;
                const countryFilter = document.getElementById('countryFilter').value;
                const yearFilter = document.getElementById('yearFilter').value;
                const typeFilter = document.getElementById('typeFilter').value;
                const searchInput = document.getElementById('searchInput').value;
                
                if (genreFilter) params.append('genre_id', genreFilter);
                if (countryFilter) params.append('country_id', countryFilter);
                if (yearFilter) params.append('release_year', yearFilter);
                if (typeFilter) params.append('type', typeFilter);
                if (searchInput) params.append('search', searchInput);
                
                const response = await fetch(`/api/movies?${params}`);
                const movies = await response.json();
                
                displayMovies(movies);
            } catch (error) {
                console.error('Error loading movies:', error);
                document.getElementById('moviesTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" class="error">Lỗi khi tải danh sách phim</td>
                    </tr>
                `;
            }
        }

        // Hiển thị danh sách phim
        function displayMovies(movies) {
            const tbody = document.getElementById('moviesTableBody');
            const movieCount = document.getElementById('movieCount');
            
            movieCount.textContent = `Danh sách phim (${movies.length} phim)`;
            
            if (movies.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="no-data">Không có phim nào</td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = movies.map(movie => `
                <tr>
                    <td>
                        <img src="${movie.poster_url || 'https://via.placeholder.com/45x65/3f51b5/ffffff?text=No+Image'}" 
                             class="movie-poster" alt="${movie.title}">
                    </td>
                    <td>${movie.title}</td>
                    <td>${movie.genres || 'Chưa phân loại'}</td>
                    <td>${movie.release_year || 'N/A'}</td>
                    <td>
                        <span class="rating ${getRatingClass(movie.average_rating)}">
                            ${movie.average_rating ? movie.average_rating + '/10' : 'Chưa có'}
                        </span>
                    </td>
                    <td>${movie.view_count?.toLocaleString() || 0}</td>
                    <td>
                        <span class="badge ${movie.is_series ? 'badge-warning' : 'badge-info'}">
                            ${movie.is_series ? 'Phim bộ' : 'Phim lẻ'}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <div class="action-btn episode-btn" data-id="${movie.id}" title="Quản lý tập phim">
                                <i class="fas fa-play-circle"></i>
                            </div>
                            <div class="action-btn edit-btn" data-id="${movie.id}" title="Chỉnh sửa">
                                <i class="fas fa-edit"></i>
                            </div>
                            <div class="action-btn delete-btn" data-id="${movie.id}" title="Xóa">
                                <i class="fas fa-trash"></i>
                            </div>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            // Thêm event listeners
            document.querySelectorAll('.episode-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const movieId = this.dataset.id;
                    // Chuyển hướng đến trang tập phim với movie_id
                    window.location.href = `/tap-phim?movie_id=${movieId}`;
                });
            });
            
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    editMovie(this.dataset.id);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    deleteMovie(this.dataset.id);
                });
            });
        }

        // Lấy class cho rating
        function getRatingClass(rating) {
            if (!rating) return 'rating-none';
            if (rating >= 8) return 'rating-high';
            if (rating >= 6) return 'rating-medium';
            return 'rating-low';
        }

        // Modal functions
        function setupModalEvents() {
            const movieModal = document.getElementById('movieModal');
            const closeModal = document.getElementById('closeModal');
            const cancelBtn = document.getElementById('cancelBtn');
            const saveMovieBtn = document.getElementById('saveMovieBtn');

            closeModal.addEventListener('click', closeMovieModal);
            cancelBtn.addEventListener('click', closeMovieModal);
            saveMovieBtn.addEventListener('click', saveMovie);
        }

        function openAddModal() {
            const modalTitle = document.getElementById('modalTitle');
            modalTitle.textContent = 'Thêm phim mới';
            currentEditingMovieId = null;
            document.getElementById('movieForm').reset();
            document.getElementById('movieModal').style.display = 'flex';
        }

        function closeMovieModal() {
            document.getElementById('movieModal').style.display = 'none';
            document.getElementById('movieForm').reset();
            currentEditingMovieId = null;
        }

        async function editMovie(movieId) {
            try {
                const response = await fetch(`/api/movies/${movieId}`);
                const movie = await response.json();
                
                if (!movie.error) {
                    const modalTitle = document.getElementById('modalTitle');
                    modalTitle.textContent = 'Chỉnh sửa phim';
                    
                    // Điền dữ liệu vào form
                    document.getElementById('movieTitle').value = movie.title;
                    document.getElementById('movieSlug').value = movie.slug;
                    document.getElementById('movieDescription').value = movie.description || '';
                    document.getElementById('movieMetaDescription').value = movie.meta_description || '';
                    document.getElementById('movieReleaseYear').value = movie.release_year || '';
                    document.getElementById('movieDuration').value = movie.duration || '';
                    // Note: moviePosterFile cannot be pre-filled due to security restrictions
                    document.getElementById('movieTrailerUrl').value = movie.trailer_url || '';
                    document.getElementById('movieVideoUrl').value = movie.video_url || '';
                    document.getElementById('movieIsSeries').checked = movie.is_series || false;
                    document.getElementById('movieIsFeatured').checked = movie.is_featured || false;
                    
                    // Xử lý thể loại, quốc gia, diễn viên (cần parse từ string sang array)
                    if (movie.genre_ids) {
                        const genreIds = movie.genre_ids.split(',').map(id => id.trim());
                        setSelectedOptions('movieGenres', genreIds);
                    }
                    
                    if (movie.country_ids) {
                        const countryIds = movie.country_ids.split(',').map(id => id.trim());
                        setSelectedOptions('movieCountries', countryIds);
                    }
                    
                    if (movie.actor_ids) {
                        const actorIds = movie.actor_ids.split(',').map(id => id.trim());
                        setSelectedOptions('movieActors', actorIds);
                    }
                    
                    currentEditingMovieId = movieId;
                    document.getElementById('movieModal').style.display = 'flex';
                } else {
                    alert('Không tìm thấy phim');
                }
            } catch (error) {
                console.error('Error loading movie:', error);
                alert('Lỗi khi tải thông tin phim');
            }
        }

        // Thiết lập selected options cho select multiple
        function setSelectedOptions(selectId, values) {
            const select = document.getElementById(selectId);
            const options = select.options;
            
            for (let i = 0; i < options.length; i++) {
                options[i].selected = values.includes(options[i].value);
            }
        }

        async function saveMovie() {
            const form = document.getElementById('movieForm');
            const formData = new FormData(form);
            
            // Add non-file inputs manually
            formData.append('title', document.getElementById('movieTitle').value);
            formData.append('slug', document.getElementById('movieSlug').value);
            formData.append('description', document.getElementById('movieDescription').value);
            formData.append('meta_description', document.getElementById('movieMetaDescription').value);
            formData.append('release_year', document.getElementById('movieReleaseYear').value);
            formData.append('duration', document.getElementById('movieDuration').value);
            formData.append('trailer_url', document.getElementById('movieTrailerUrl').value);
            formData.append('video_url', document.getElementById('movieVideoUrl').value);
            formData.append('is_series', document.getElementById('movieIsSeries').checked);
            formData.append('is_featured', document.getElementById('movieIsFeatured').checked);
            formData.append('genre_ids', getSelectedValues('movieGenres'));
            formData.append('country_ids', getSelectedValues('movieCountries'));
            formData.append('actor_ids', getSelectedValues('movieActors'));

            if (!formData.get('title') || !formData.get('slug')) {
                alert('Vui lòng điền đầy đủ thông tin bắt buộc (Tên phim và Slug)!');
                return;
            }

            try {
                const url = currentEditingMovieId ? 
                    `/api/movies/${currentEditingMovieId}` : '/api/movies';
                const method = currentEditingMovieId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    alert(currentEditingMovieId ? 
                        'Cập nhật phim thành công!' : 'Thêm phim thành công!');
                    closeMovieModal();
                    loadMovies();
                } else {
                    alert('Lỗi: ' + (result.error || 'Không thể lưu phim'));
                }
            } catch (error) {
                console.error('Error saving movie:', error);
                alert('Lỗi khi lưu phim');
            }
        }

        // Lấy giá trị selected từ select multiple
        function getSelectedValues(selectId) {
            const select = document.getElementById(selectId);
            const selectedValues = [];
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].selected) {
                    selectedValues.push(select.options[i].value);
                }
            }
            return selectedValues;
        }

        async function deleteMovie(movieId) {
            if (!confirm('Bạn có chắc chắn muốn xóa phim này không?')) {
                return;
            }

            try {
                const response = await fetch(`/api/movies/${movieId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    alert('Xóa phim thành công!');
                    loadMovies();
                } else {
                    alert('Lỗi: ' + (result.error || 'Không thể xóa phim'));
                }
            } catch (error) {
                console.error('Error deleting movie:', error);
                alert('Lỗi khi xóa phim');
            }
        }

        // Export to Excel
        function exportToExcel() {
            alert('Tính năng xuất Excel sẽ được triển khai sau!');
        }

        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Xử lý sự kiện cho sidebar
        document.querySelectorAll('.sidebar-menu a').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.sidebar-menu a').forEach(link => {
                    link.classList.remove('active');
                });
                this.classList.add('active');
            });
        });
    </script>
</body>
</html>